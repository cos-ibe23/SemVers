name: Promote Service

on:
  workflow_dispatch:
    inputs:
      service:
        required: true
        type: choice
        options:
          - backend
          - frontend
          - receipt
      rc_tag:
        description: "RC tag (e.g. v0.2.0-rc.17)"
        required: true

env:
  REGISTRY: ghcr.io
  OWNER: imbod

permissions:
  contents: read
  packages: write
jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install crane + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -sL https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz | tar -xz
          sudo mv crane /usr/local/bin/

      - name: Log in to Container Registry
        uses: ./.github/actions/setup-docker
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify RC exists
        run: |
          IMAGE="$REGISTRY/$OWNER/imbod-${{ inputs.service }}:${{ inputs.rc_tag }}"
          crane digest "$IMAGE" > /dev/null

      - name: Promote by digest
        id: promote
        run: |
          IMAGE="$REGISTRY/$OWNER/imbod-${{ inputs.service }}:${{ inputs.rc_tag }}"
          DIGEST=$(crane digest "$IMAGE")

          RC_TAG="${{ inputs.rc_tag }}"
          REGISTRY_TAG="${RC_TAG%-rc.*}"

          echo "Promoting:"
          echo "  RC:     $IMAGE"
          echo "  Registry tag: $REGISTRY_TAG"
          echo "  Digest: $DIGEST"

          crane copy \
            "$IMAGE@$DIGEST" \
            "$REGISTRY/$OWNER/imbod-${{ inputs.service }}:$REGISTRY_TAG"

          echo "registry_tag=$REGISTRY_TAG" >> $GITHUB_OUTPUT


      - name: Clear GitHub App auth header
        run: |
            git config --global --unset-all http.https://github.com/.extraheader || true

    
      - name: Configure git auth (force PAT)
        run: |
          git config --global user.email "release-bot@imbod.local"
          git config --global user.name "Imbod Release Bot"

          git remote set-url origin \
            https://x-access-token:${{ secrets.PROMOTION_PAT }}@github.com/Imbod/apps.git

          echo "Remote set to:"
          git remote -v
    
      - name: Tag source commit
        run: |
          IMAGE="$REGISTRY/$OWNER/imbod-${{ inputs.service }}:${{ inputs.rc_tag }}"
          DIGEST=$(crane digest "$IMAGE")

          COMMIT=$(crane config "$IMAGE@$DIGEST" \
            | jq -r '.config.Labels["org.opencontainers.image.revision"]')

          REGISTRY_TAG="${{ steps.promote.outputs.registry_tag }}"
          GIT_TAG="${{ inputs.service }}-${REGISTRY_TAG}"

          echo "Tagging commit: $COMMIT"
          echo "Git tag: $GIT_TAG"

          git fetch --tags
          git tag -f "$GIT_TAG" "$COMMIT"
          git push origin "$GIT_TAG"
